{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://example.local/schemas/step.schema.json",
  "title": "Workflow Step",
  "type": "object",
  "additionalProperties": false,
  "required": ["id", "driver", "action", "target", "retry", "pre_assert", "post_assert"],
  "properties": {
    "id": {
      "type": "string",
      "minLength": 1,
      "pattern": "^[a-zA-Z0-9_\\-\\.]+$"
    },
    "name": {
      "type": "string",
      "minLength": 1
    },
    "driver": {
      "type": "string",
      "enum": ["web", "desktop"]
    },
    "action": {
      "type": "string",
      "enum": [
        "focus_window",
        "launch_browser",
        "attach_browser",
        "navigate",
        "click",
        "double_click",
        "right_click",
        "fill",
        "type",
        "paste",
        "select",
        "wait_for",
        "assert",
        "extract",
        "hotkey",
        "sleep",
        "scroll",
        "branch",
        "loop"
      ]
    },

    "explain": {
      "type": "string",
      "minLength": 1,
      "description": "Human-readable explanation for verification mode."
    },

    "target": {
      "type": "object",
      "additionalProperties": false,
      "required": ["ladder"],
      "properties": {
        "ladder": {
          "type": "array",
          "minItems": 1,
          "items": { "$ref": "#/$defs/TargetRung" }
        },
        "scope": { "$ref": "#/$defs/Scope" }
      }
    },

    "input": { "$ref": "#/$defs/InputValue" },

    "params": {
      "type": "object",
      "additionalProperties": true,
      "description": "Action-specific parameters (e.g., url for navigate, key combo for hotkey)."
    },

    "retry": { "$ref": "#/$defs/RetryPolicy" },

    "timeouts": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "step_timeout_ms": { "type": "integer", "minimum": 0 },
        "wait_timeout_ms": { "type": "integer", "minimum": 0 }
      }
    },

    "pre_assert": {
      "type": "array",
      "minItems": 1,
      "items": { "$ref": "#/$defs/Assertion" },
      "description": "Must hold before the action is attempted."
    },
    "post_assert": {
      "type": "array",
      "minItems": 1,
      "items": { "$ref": "#/$defs/Assertion" },
      "description": "Must hold after the action completes to consider it successful."
    },

    "review": {
      "type": "object",
      "additionalProperties": false,
      "description": "Verification-mode decisions and comments.",
      "properties": {
        "history": {
          "type": "array",
          "items": { "$ref": "#/$defs/ReviewDecision" }
        },
        "final_state": {
          "type": "string",
          "enum": ["unreviewed", "proceeded", "proceeded_with_comments", "raised_issue"]
        }
      }
    },

    "evidence": {
      "type": "object",
      "additionalProperties": false,
      "description": "Links to artifacts captured during verification or runtime.",
      "properties": {
        "before_screenshot": { "type": "string" },
        "after_screenshot": { "type": "string" },
        "match_trace": { "type": "string" }
      }
    },

    "tags": {
      "type": "array",
      "items": { "type": "string", "minLength": 1 }
    }
  },

  "$defs": {
    "RetryPolicy": {
      "type": "object",
      "additionalProperties": false,
      "required": ["attempts", "wait_ms"],
      "properties": {
        "attempts": { "type": "integer", "minimum": 0, "maximum": 20 },
        "wait_ms": { "type": "integer", "minimum": 0, "maximum": 120000 },
        "backoff": {
          "type": "string",
          "enum": ["none", "linear", "exponential"]
        }
      }
    },

    "Scope": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "web": { "$ref": "#/$defs/WebScope" },
        "desktop": { "$ref": "#/$defs/DesktopScope" }
      }
    },

    "WebScope": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "url_contains": { "type": "string" },
        "url_equals": { "type": "string" },
        "title_contains": { "type": "string" },
        "frame": { "type": "string", "description": "Frame name or selector." }
      }
    },

    "DesktopScope": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "process_name": { "type": "string" },
        "window_title_contains": { "type": "string" },
        "window_class": { "type": "string" }
      }
    },

    "InputValue": {
      "description": "Value sources used by fill/type/paste/select actions.",
      "oneOf": [
        { "type": "string" },
        { "type": "number" },
        { "type": "boolean" },
        { "type": "null" },
        {
          "type": "object",
          "additionalProperties": false,
          "required": ["var"],
          "properties": {
            "var": { "type": "string", "minLength": 1 },
            "transform": {
              "type": "string",
              "enum": ["none", "trim", "upper", "lower"]
            }
          }
        }
      ]
    },

    "TargetRung": {
      "type": "object",
      "additionalProperties": false,
      "required": ["kind", "selector", "confidence"],
      "properties": {
        "kind": {
          "type": "string",
          "enum": [
            "web_role",
            "web_label",
            "web_css",
            "web_text",
            "web_xpath",
            "uia",
            "uia_near_label",
            "uia_path",
            "ocr_anchor",
            "coords"
          ]
        },
        "confidence": {
          "type": "number",
          "minimum": 0,
          "maximum": 1
        },
        "selector": {
          "type": "object",
          "description": "Selector payload varies by kind (see definitions below).",
          "oneOf": [
            { "$ref": "#/$defs/WebRoleSelector" },
            { "$ref": "#/$defs/WebLabelSelector" },
            { "$ref": "#/$defs/WebCssSelector" },
            { "$ref": "#/$defs/WebTextSelector" },
            { "$ref": "#/$defs/WebXpathSelector" },
            { "$ref": "#/$defs/UIASelector" },
            { "$ref": "#/$defs/UIANearLabelSelector" },
            { "$ref": "#/$defs/UIAPathSelector" },
            { "$ref": "#/$defs/OcrAnchorSelector" },
            { "$ref": "#/$defs/CoordsSelector" }
          ]
        },
        "notes": { "type": "string" }
      }
    },

    "WebRoleSelector": {
      "type": "object",
      "additionalProperties": false,
      "required": ["role", "name"],
      "properties": {
        "role": { "type": "string" },
        "name": { "type": "string" },
        "exact": { "type": "boolean" }
      }
    },

    "WebLabelSelector": {
      "type": "object",
      "additionalProperties": false,
      "required": ["text"],
      "properties": {
        "text": { "type": "string" },
        "exact": { "type": "boolean" }
      }
    },

    "WebCssSelector": {
      "type": "object",
      "additionalProperties": false,
      "required": ["css"],
      "properties": {
        "css": { "type": "string" }
      }
    },

    "WebTextSelector": {
      "type": "object",
      "additionalProperties": false,
      "required": ["text"],
      "properties": {
        "text": { "type": "string" },
        "exact": { "type": "boolean" },
        "within_css": { "type": "string" }
      }
    },

    "WebXpathSelector": {
      "type": "object",
      "additionalProperties": false,
      "required": ["xpath"],
      "properties": {
        "xpath": { "type": "string" }
      }
    },

    "UIASelector": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "automationId": { "type": "string" },
        "name": { "type": "string" },
        "className": { "type": "string" },
        "frameworkId": { "type": "string" },
        "controlType": { "type": "string" }
      }
    },

    "UIANearLabelSelector": {
      "type": "object",
      "additionalProperties": false,
      "required": ["label", "controlType"],
      "properties": {
        "label": { "type": "string" },
        "controlType": { "type": "string" },
        "maxDistancePx": { "type": "integer", "minimum": 0, "maximum": 2000 },
        "direction": {
          "type": "string",
          "enum": ["any", "right_of", "left_of", "below", "above"]
        }
      }
    },

    "UIAPathSelector": {
      "type": "object",
      "additionalProperties": false,
      "required": ["path"],
      "properties": {
        "path": {
          "type": "array",
          "minItems": 1,
          "items": { "$ref": "#/$defs/UIAPathNode" }
        }
      }
    },

    "UIAPathNode": {
      "type": "object",
      "additionalProperties": false,
      "required": ["controlType"],
      "properties": {
        "controlType": { "type": "string" },
        "name": { "type": "string" },
        "automationId": { "type": "string" },
        "index": { "type": "integer", "minimum": 0, "maximum": 1000 }
      }
    },

    "OcrAnchorSelector": {
      "type": "object",
      "additionalProperties": false,
      "required": ["anchorText", "clickOffset"],
      "properties": {
        "anchorText": { "type": "string" },
        "exact": { "type": "boolean" },
        "clickOffset": {
          "type": "object",
          "additionalProperties": false,
          "required": ["dx", "dy"],
          "properties": {
            "dx": { "type": "integer", "minimum": -5000, "maximum": 5000 },
            "dy": { "type": "integer", "minimum": -5000, "maximum": 5000 }
          }
        }
      }
    },

    "CoordsSelector": {
      "type": "object",
      "additionalProperties": false,
      "required": ["x", "y"],
      "properties": {
        "x": { "type": "integer", "minimum": 0, "maximum": 100000 },
        "y": { "type": "integer", "minimum": 0, "maximum": 100000 },
        "requires_window_lock": { "type": "boolean" }
      }
    },

    "Assertion": {
      "type": "object",
      "additionalProperties": false,
      "required": ["kind"],
      "properties": {
        "kind": {
          "type": "string",
          "enum": [
            "web_exists",
            "web_visible",
            "web_url_contains",
            "web_url_equals",
            "web_title_contains",
            "web_text_contains",
            "web_text_equals",
            "web_value_equals",
            "web_value_contains",
            "desktop_window_active",
            "desktop_element_exists",
            "desktop_element_visible",
            "desktop_focused_controlType",
            "desktop_value_equals",
            "desktop_value_contains",
            "not"
          ]
        },

        "target": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "ladder": {
              "type": "array",
              "minItems": 1,
              "items": { "$ref": "#/$defs/TargetRung" }
            },
            "scope": { "$ref": "#/$defs/Scope" }
          }
        },

        "text": { "type": "string" },
        "value": { "type": "string" },

        "controlType": { "type": "string" },

        "url_contains": { "type": "string" },
        "title_contains": { "type": "string" },

        "timeout_ms": { "type": "integer", "minimum": 0, "maximum": 300000 },

        "assert": {
          "description": "Used only when kind=not",
          "$ref": "#/$defs/Assertion"
        }
      },
      "allOf": [
        {
          "if": { "properties": { "kind": { "const": "not" } } },
          "then": { "required": ["assert"] }
        }
      ]
    },

    "ReviewDecision": {
      "type": "object",
      "additionalProperties": false,
      "required": ["at", "decision"],
      "properties": {
        "at": {
          "type": "string",
          "format": "date-time"
        },
        "decision": {
          "type": "string",
          "enum": ["proceed", "proceed_with_comments", "raise_issue_with_comments"]
        },
        "comment": {
          "type": "string"
        },
        "actor": {
          "type": "string",
          "description": "Optional user identifier."
        }
      }
    }
  }
}
